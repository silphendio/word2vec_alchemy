<!DOCTYPE html>
<html lang="de">
  <head>
    <title>Word2Vec Alchemy</title>
    <meta charset="utf-8" />
    <meta name="color-scheme" content="dark light" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/mathjs@12.3.1/lib/browser/math.js"></script>
  </head>

  <body>
    <h1>Word2Vec Arithmetic</h1>
    <p id="loading_text">loading...</p>
    <form action="javascript:eval_word_math_input()">
      <input type="text" id="word_math_input" placeholder="king + (woman - man) * 2">
      <input type="submit" value="calculate">
    </form>
    <span id="error_span"></span>
    <br>
    <a href="https://www.desiquintans.com/nounlist">dictionary is limited to common nouns</a><br>
    Closest words are calculated using Cosine Similarity, so scaling doesn't matter.
    <h3>Results:</h3>
    <table id="results_table">

    </table>

    <br>
    <div>
      <a href="index.html">Alchemy Sandbox</a>
      <br>
      <a href="https://github.com/silphendio/word2vec_alchemy">Github Repository</a>
      <br>
      powered by <a href="https://mathjs.org">math.js</a>
    </div>

    <script>
// helper functions
function $(query){ return document.querySelector(query) }
function el(name, attributes = {}, children = []){
  let el = document.createElement(name)
  for(let a in attributes){
  el.setAttribute(a, attributes[a])
  }
  el.append(...children)
  return el
}

// variables
var embeddings = null

fetch("noun_embeddings.json")
  .then(res => res.json())
  .then(res => {embeddings = res; $('#loading_text').hidden=true})
//fetch("noun_embeddings.json").then(res => res.json()).then(res => embeddings = res)
const found_words = new Set()



function eval_word_math_input(num_results = 10){
  $('#error_span').hidden = true
  $('#results_table').innerHTML = ""

  let expr = $('#word_math_input').value

  console.log("looking up vectors...")
  // replacing words
  while(true){
    let match = expr.match(/[a-zA-Z]+/)
    if(match === null) break

    let word = match[0].toLocaleLowerCase()

    if(!(word in embeddings)){
      // TODO: better error handling
      
      $('#error_span').hidden = false
      $('#error_span').textContent = "Error: '" + word + "' is not in dictionary"
      return
    }
    expr = expr.replace(match[0], JSON.stringify(embeddings[word]))
  }

  console.log("calculating...")


  // calculating...
  try{
    result = math.evaluate(expr).toArray()
  }
  catch(error){
    $('#error_span').hidden = false
    $('#error_span').textContent = error
    return
  }
  matches = find_topk_words(result, num_results)


  // add matches into results_table
  let results_table = $('#results_table')

  for(let i=0; i<num_results; ++i){
    results_table.append(el('tr', {}, [
      el('td', {}, matches[i].word),
      el('td', {}, String(matches[i].similarity)),
    ]))
  }
}

function find_topk_words(word_vec, num_results = 1, exclude_words = []){
  word_vec = math.squeeze(word_vec)
  word_vec = math.divide(word_vec, math.norm(result))
  
  let matches = new Array(num_results).fill({word: "", similarity: -Infinity})

  for (let [word, embd] of Object.entries(embeddings)){

    if(exclude_words.includes(word)) continue

    embd = math.divide(embd, math.norm(embd))
    let s = math.dot(word_vec, embd)

    let i = num_results
    while(i > 0 && s > matches[i-1].similarity) i -= 1
    if(i < num_results){
      matches.splice(i, 0, {word: word, similarity: s})
    }
  }
  return matches

}


    </script>
    <style>
.highlight {
  background-color:darkorange;
}

table, th, td {
  border:1px solid;
}
#error_span {
  color:red;
}

    </style>
  </body>
</html>